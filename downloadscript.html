<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script v2.0 Preview & Download</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --light-text: #f1f5f9;
            --gray-text: #94a3b8;
            --border: #334155;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: var(--dark-bg);
            color: var(--light-text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            margin: 0 auto;
        }
        
        /* Header Styles */
        header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        header p {
            color: var(--gray-text);
            font-size: 1.1rem;
        }
        
        /* Main Content Layout - Two Columns */
        .main-content {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .left-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
			max-width:15%;
        }
        
        .right-column {
            flex: 1.5;
        }
        
        /* Left Column Cards */
        .card {
            background: var(--dark-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .card-title {
            font-size: 1.3rem;
            color: var(--light-text);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px 24px;
            border-radius: 12px;
            border: none;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            text-align: left;
            width: 100%;
        }
        
        .action-btn i {
            font-size: 1.2rem;
            min-width: 24px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        
        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        
        .copy-btn {
            background: linear-gradient(135deg, var(--secondary), #0d9c6d);
        }
        
        .copy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        
        .preview-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .preview-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
        }
        
        /* Script Info */
        .script-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }
        
        .info-label {
            font-size: 0.85rem;
            color: var(--gray-text);
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1rem;
            color: var(--light-text);
            font-weight: 600;
        }
        
        /* Features */
        .features-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .feature-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .feature-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .feature-icon {
            color: var(--primary);
            font-size: 1.2rem;
            min-width: 24px;
            margin-top: 2px;
        }
        
        .feature-text h4 {
            color: var(--light-text);
            margin-bottom: 5px;
            font-size: 1.05rem;
        }
        
        .feature-text p {
            color: var(--gray-text);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* Right Column - Code Preview */
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .preview-header h2 {
            font-size: 1.5rem;
            color: var(--light-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .size-control {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .size-control label {
            font-size: 0.9rem;
            color: var(--gray-text);
        }
        
        .size-control input {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--light-text);
            padding: 5px 10px;
            border-radius: 6px;
            width: 70px;
            text-align: center;
        }
        
        /* Code Preview Container */
        .code-container {
            background: #0d1117;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            height: 1700px;
            display: flex;
            flex-direction: column;
        }
        
        .code-header {
            background: #161b22;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .filename {
            font-weight: 600;
            color: var(--light-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .code-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #c9d1d9;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
        }
        
        /* Syntax highlighting */
        .keyword {
            color: #ff7b72;
        }
        
        .string {
            color: #a5d6ff;
        }
        
        .comment {
            color: #8b949e;
        }
        
        .number {
            color: #79c0ff;
        }
        
        .function {
            color: #d2a8ff;
        }
        
        .variable {
            color: #ffa657;
        }
        
        /* Footer */
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--gray-text);
            font-size: 0.9rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            background: var(--secondary);
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
 
        
      
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-code"></i> Script v2.0</h1>
            <p>PMTA Monitoring & Automation Script - Preview and Download</p>
        </header>
        
        <!-- Main Content - Two Columns -->
        <div class="main-content">
            <!-- Left Column: Buttons and Description -->
            <div class="left-column">
                <!-- Action Buttons Card -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-download"></i> Download & Actions</h2>
                    <div class="action-buttons">
                        <button class="action-btn download-btn" id="downloadBtn">
                            <i class="fas fa-download"></i>
                            <div>
                                <div>Download Script</div>
                                <div style="font-size: 0.9rem; font-weight: normal; opacity: 0.9;">Get the script_v2.0.js file</div>
                            </div>
                        </button>
                        <button class="action-btn copy-btn" id="copyCode">
                            <i class="far fa-copy"></i>
                            <div>
                                <div>Copy Code to Clipboard</div>
                                <div style="font-size: 0.9rem; font-weight: normal; opacity: 0.9;">Copy entire script to clipboard</div>
                            </div>
                        </button>
                        <button class="action-btn preview-btn" id="previewRawBtn">
                            <i class="fas fa-external-link-alt"></i>
                            <div>
                                <div>View Raw Code</div>
                                <div style="font-size: 0.9rem; font-weight: normal; opacity: 0.9;">Open in new tab for full view</div>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Script Information Card -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-info-circle"></i> Script Information</h2>
                    <div class="script-info-grid">
                        <div class="info-item">
                            <div class="info-label">File Name</div>
                            <div class="info-value">script_v2.0.js</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">File Type</div>
                            <div class="info-value">JavaScript</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Size</div>
                            <div class="info-value">~12 KB</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Version</div>
                            <div class="info-value">2.0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Compatible With</div>
                            <div class="info-value">iMacros</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Lines of Code</div>
                            <div class="info-value">~400</div>
                        </div>
                    </div>
                </div>
                
                <!-- Features Card -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-star"></i> Key Features</h2>
                    <div class="features-list">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                            <div class="feature-text">
                                <h4>Automated Scheduling</h4>
                                <p>Executes PMTA commands at specified times with configurable repetitions and wait intervals.</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="feature-text">
                                <h4>Multi-Server Monitoring</h4>
                                <p>Monitors multiple IP addresses and extracts queue data from PMTA interfaces.</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="feature-text">
                                <h4>Telegram Notifications</h4>
                                <p>Sends status updates and extraction results to Telegram via bot API.</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="feature-text">
                                <h4>Configuration Management</h4>
                                <p>Centralized configuration for time settings, API keys, and execution parameters.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Code Preview -->
            <div class="right-column">
                <div class="card">
                    <div class="preview-header">
                        <h2><i class="fas fa-eye"></i> Code Preview</h2>
                        <div class="preview-controls">
                            <div class="size-control">
                                <label for="previewHeight">Height:</label>
                                <input type="number" id="previewHeight" value="600" min="300" max="1000" step="50">
                                <span>px</span>
                            </div>
                            <div class="size-control">
                                <label for="fontSize">Font Size:</label>
                                <input type="number" id="fontSize" value="14" min="10" max="20" step="1">
                                <span>px</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Code Container -->
                    <div class="code-container" id="codeContainer">
                        <div class="code-header">
                            <div class="filename">
                                <i class="fas fa-file-code"></i> script_v2.0.js
                            </div>
                            <div class="file-size">~12 KB | ~400 lines</div>
                        </div>
                        <div class="code-content" id="codeContent">
                            <!-- Code will be inserted here by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>This script is designed for use with iMacros browser automation tool.</p>
            <p>Make sure to configure the settings according to your environment before use.</p>
            <p style="margin-top: 10px; color: var(--primary); font-weight: 600;">© 2023 Script v2.0 | PMTA Monitoring & Automation</p>
        </footer>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Code copied to clipboard!</span>
    </div>
    
    <script>
        // The script content from the user
        const scriptContent = `var pmtaList = [
    {
        url: "http://95.216.72.6:90/multi_monitor/list?q=y5CAQyjhPSVBkBbccClQPmmvM1dnags3",
        targetTime: "18:05:00",
        nameprod: "E"
    }
];

var config = {
    timefinish: "14:42:00",
    geoApiKey: "67749947756e4891ad0fa24fae372533",
    enableFinishTime: false,
    telegram: {
        botToken: "888888888:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
        chatId: "8484848484"
    },
    macro: {
        scheduleRepeats: 130,
        scheduleWait: 5
    }
};

var IPvols = [
    {
        IP: "123.123.123.123",
        vol: "30000"
    },
    {
        IP: "123.123.123.122",
        vol: "30000"
    }
];

var timeCache = {
    value: null,
    lastUpdate: 0
};

var utils = {
    zeroPad: function(num, length) {
        return num.toString().padStart(length, '0');
    },
    
    log: function(message) {
        iimDisplay(message);
        iimSet("message", message);
        iimPlay("CODE:SET !EXTRACT {{message}}");
    },
    
    parseTime: function(timeStr) {
        var parts = timeStr.split(':');
        return {
            hours: parseInt(parts[0]),
            minutes: parseInt(parts[1]),
            seconds: parseInt(parts[2] || 0)
        };
    },
    
    createDateFromTime: function(timeObj) {
        var date = new Date();
        date.setUTCHours(timeObj.hours);
        date.setUTCMinutes(timeObj.minutes);
        date.setUTCSeconds(timeObj.seconds);
        return date;
    }
};

var timeManager = {
    getCurrentUTC: function() {
        var now = Date.now();
        if (timeCache.value && (now - timeCache.lastUpdate) < config.timeCacheDuration) {
            return timeCache.value;
        }
        
        var apiUrl = "https://api.ipgeolocation.io/timezone?apiKey=" + config.geoApiKey + "&lat=33.5731&long=-7.5898";
        
        try {
            var macro = "CODE:\nSET !ERRORIGNORE YES\nWAIT SECONDS=2\n";
            macro += "URL GOTO=" + apiUrl + "\nWAIT SECONDS=2\n";
            macro += "TAG POS=1 TYPE=PRE ATTR=* EXTRACT=TXT\nSET !ERRORIGNORE NO\n";
            
            iimPlay(macro);
            var response = iimGetLastExtract();
            
            if (response) {
                var jsonStr = response.trim();
                var start = jsonStr.indexOf('{');
                var end = jsonStr.lastIndexOf('}') + 1;
                
                if (start >= 0 && end > start) {
                    var data = JSON.parse(jsonStr.substring(start, end));
                    var utcTime = new Date(data.date_time_wti).toUTCString();
                    var match = utcTime.match(/(\d{2}:\d{2}:\d{2})/);
                    
                    if (match) {
                        timeCache.value = match[0];
                        timeCache.lastUpdate = now;
                        return timeCache.value;
                    }
                }
            }
        } catch (e) {
            utils.log("API error: " + e);
        }
        
        var d = new Date();
        timeCache.value = utils.zeroPad(d.getUTCHours(), 2) + ":" + 
                         utils.zeroPad(d.getUTCMinutes(), 2) + ":" + 
                         utils.zeroPad(d.getUTCSeconds(), 2);
        timeCache.lastUpdate = now;
        return timeCache.value;
    },
    
    addHours: function(timeStr, hours) {
        var time = utils.parseTime(timeStr);
        time.hours = (time.hours + hours) % 24;
        return utils.zeroPad(time.hours, 2) + ":" + 
               utils.zeroPad(time.minutes, 2) + ":" + 
               utils.zeroPad(time.seconds, 2);
    },
    
    calculateRemaining: function(targetTime) {
        var current = utils.createDateFromTime(utils.parseTime(this.getCurrentUTC()));
        var target = utils.createDateFromTime(utils.parseTime(targetTime));
        
        if (target <= current) {
            target.setUTCDate(target.getUTCDate() + 1);
        }
        
        return Math.floor((target - current) / 1000);
    },
    
    shouldStop: function() {
        if (!config.enableFinishTime) return false;
        
        var remaining = this.calculateRemaining(config.timefinish);
        if (remaining < 7200) {
            utils.log("Less than 2 hours to finish time. Stopping.");
            return true;
        }
        return false;
    }
};

var dataExtractor = {
IP: [
        "12.68.32.91",
        "12.68.32.91",
     
    ],
    
    extractPageText: function() {
        iimPlay("CODE:\nSET !ERRORIGNORE YES\nTAG POS=1 TYPE=BODY ATTR=* EXTRACT=TXT\nSET !ERRORIGNORE NO");
        return iimGetLastExtract();
    },
    
    parseNumber: function(str) {
        if (!str) return "0";
        return str.trim();
    },
    
    removeGmailPrefix: function(name) {
        return name.replace(/^gmail-/, '');
    },
    
    extractServerInfo: function(text) {
        var serverInfo = {};
        
        if (!text || text === "#EANF#") return serverInfo;
        
        var pattern = /(\d+)\s*-\s*([\w_]+)\s*-\s*(\d+\.\d+\.\d+\.\d+)/g;
        var match;
        
        while ((match = pattern.exec(text)) !== null) {
            var ip = match[3];
            var serverName = match[2];
            serverInfo[ip] = serverName + " - " + ip;
        }
        
        return serverInfo;
    },
    
    isVoIP: function(ip) {
        for (var i = 0; i < IPvols.length; i++) {
            if (IPvols[i].IP === ip) {
                return IPvols[i];
            }
        }
        return null;
    },
    
    extractTabularData: function() {
        var text = this.extractPageText();
        if (!text || text === "#EANF#") return [];
        
        var results = [];
        var lines = text.split('\n');
        
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            
            if (line.indexOf('gmail-') !== -1) {
                var parts = line.split(/\t|\s{2,}/);
                var cleanParts = [];
                for (var p = 0; p < parts.length; p++) {
                    var trimmed = parts[p].trim();
                    if (trimmed !== '') {
                        cleanParts.push(trimmed);
                    }
                }
                
                if (cleanParts.length >= 3) {
                    var name = cleanParts[0];
                    var rcpt = cleanParts[2];
                    rcpt = rcpt.replace(/[^\d,]/g, '');
                    
                    if (rcpt && rcpt !== "0" && rcpt !== "1") {
                        results.push({ name: name, rcpt: rcpt });
                        iimDisplay("✓ " + name + " = " + rcpt);
                    }
                }
            }
        }
        
        return results;
    },
    
    extractWithRegex: function() {
        var text = this.extractPageText();
        if (!text || text === "#EANF#") return [];
        
        var results = [];
        var pattern = /(gmail-\d+\.\d+\.\d+\.\d+)\s+1\s+([\d,]+)/g;
        var match;
        
        while ((match = pattern.exec(text)) !== null) {
            var name = match[1];
            var rcpt = match[2];
            rcpt = rcpt.replace(/[^\d,]/g, '');
            
            if (rcpt && rcpt !== "1") {
                results.push({ name: name, rcpt: rcpt });
                iimDisplay("Regex: " + name + " = " + rcpt);
            }
        }
        
        return results;
    },
    
    sendTelegramMessage: function(message) {
        var encoded = "";
        for (var i = 0; i < message.length; i++) {
            var char = message.charAt(i);
            if (char === '\n') encoded += '%0A';
            else if (char === ' ') encoded += '%20';
            else encoded += char;
        }
        
        var url = "https://api.telegram.org/bot" + config.telegram.botToken + "/sendMessage?chat_id=" + config.telegram.chatId + "&text=" + encoded;
        
        iimPlay("CODE:\nSET !ERRORIGNORE YES\n" +
               "URL GOTO=" + url + "\n" +
               "WAIT SECONDS=3\n" +
               "SET !ERRORIGNORE NO");
        
        return 1;
    },
    
    calculateVolValue: function(volStr, rcptStr) {
        try {
            var vol = parseInt(volStr.replace(/,/g, ''));
            var rcpt = parseInt(rcptStr.replace(/,/g, ''));
            
            if (isNaN(vol)) vol = 0;
            if (isNaN(rcpt)) rcpt = 0;
            
            var result = vol - rcpt;
            return result.toLocaleString();
        } catch (e) {
            return volStr;
        }
    },
    
createMessage: function(allResults, serverInfo) {
    var filteredResults = [];
    for (var i = 0; i < allResults.length; i++) {
        if (allResults[i].total !== "0") {
            filteredResults.push(allResults[i]);
        }
    }
    
    if (filteredResults.length === 0) {
        return "No data found from any IP.";
    }
    
    var message = "";
    message += "---------------------------RESULTS-----------------------------\n\n";
    
    var grandTotal = 0;
    var voipCount = 0;
    
    for (var i = 0; i < filteredResults.length; i++) {
        var data = filteredResults[i];
        var displayName = data.ip;
        if (serverInfo[data.ip]) {
            displayName = serverInfo[data.ip];
        }
        message += "\uD83D\uDDA5 " + displayName + "\n\n";  
        
        if (data.items.length > 0) {
            for (var j = 0; j < data.items.length; j++) {
                var item = data.items[j];
                var ipAddress = this.removeGmailPrefix(item.name);
                
                var voipInfo = this.isVoIP(ipAddress);
                if (voipInfo) {
                    var calculatedVol = this.calculateVolValue(voipInfo.vol, item.rcpt);
                    message += "\uD83C\uDF10 " + ipAddress + "  \uD83D\uDCE5  " + voipInfo.vol + "   \uD83D\uDCE4  " + calculatedVol +"   \u23F3 Rcpt Q  "+item.rcpt+ "\n";
                    voipCount++;
                }
            }
        }
        message += "\nRemaining queue  : " + data.total + "\n";
        var numericTotal = parseInt(data.total.replace(/,/g, ''));
        if (!isNaN(numericTotal)) {
            grandTotal += numericTotal;
        }
    }
    
    message += "------------------------------------------------------------\n";
    message += "Total Remaining queue : " + grandTotal.toLocaleString() + "\n";
    message += "\uD83D\uDDA5 Server with data: " + filteredResults.length + "/" + allResults.length + "\n";
    message += "\uD83C\uDF10 IPs count: " + voipCount + "\n";
    
    return message;
},
    
    extractAllData: function() {
        iimDisplay("=== STARTING EXTRACTION ===");
        
        var allResults = [];
        var serverInfoCache = {};
        
        for (var i = 0; i < this.IP.length; i++) {
            var currentIP = this.IP[i];
            var url = "http://" + currentIP + ":8181/pmta?u=aHR0cDovLzEyNy4wLjAuMTo4MDgwL3ZtdGFz&refresh=20";
            
            iimDisplay("\nProcessing IP " + (i+1) + ": " + currentIP);
            
            iimPlay("CODE:\nSET !ERRORIGNORE YES\nURL GOTO=" + url + "\nWAIT SECONDS=3\nSET !ERRORIGNORE NO");
            
            var text = this.extractPageText();
            var serverInfo = this.extractServerInfo(text);
            serverInfoCache[currentIP] = serverInfo[currentIP] || currentIP;
            
            var tableData = this.extractWithRegex();
            
            if (tableData.length === 0) {
                tableData = this.extractTabularData();
            }
            
            var ipTotal = "0";
            if (tableData.length > 0) {
                var numericTotal = 0;
                for (var j = 0; j < tableData.length; j++) {
                    var rcptStr = tableData[j].rcpt;
                    var numericRcpt = parseInt(rcptStr.replace(/,/g, ''));
                    if (!isNaN(numericRcpt)) {
                        numericTotal += numericRcpt;
                    }
                }
                ipTotal = numericTotal.toLocaleString();
            }
            
            allResults.push({
                ip: currentIP,
                items: tableData,
                total: ipTotal
            });
            
            iimDisplay("Found " + tableData.length + " items, Total: " + ipTotal);
            
            iimPlay("CODE:\nSET !ERRORIGNORE YES\nWAIT SECONDS=2\nSET !ERRORIGNORE NO");
            
            if (i < this.IP.length - 1) {
                iimPlay("CODE:\nWAIT SECONDS=3");
            }
        }
        
        var message = this.createMessage(allResults, serverInfoCache);
        iimDisplay("\n" + message);
        
        iimDisplay("\nSending to Telegram...");
        this.sendTelegramMessage(message);
        
        iimDisplay("\n=== EXTRACTION COMPLETE ===");
    }
};

var macroBuilder = {
    createWaiting: function(waitSeconds, lastpmta, namep) {
        return "CODE:\n" +
               "SET !ERRORIGNORE YES\n" +
               "TAB T=1\n" +
               "WAIT SECONDS=3\n" +
               "URL GOTO=" + lastpmta + "\n" +
               "WAIT SECONDS=1\n" +
               "URL GOTO=javascript:document.title='" + namep + "';undefined;\n" +
               "WAIT SECONDS=2\n" +
               (waitSeconds > 0 ? "WAIT SECONDS=" + waitSeconds + "\n" : "");
    },
    
    createSetNormal: function(url) {
        return "CODE:\n" +
               "URL GOTO=" + url + "\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=A ATTR=TXT:Run<SP>Cmds\n" +
               "FRAME F=1\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=SPAN ATTR=TXT:set<SP>queue<SP>--mode=normal<SP>[domain]/[vmta]\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=8 TYPE=INPUT:CHECKBOX ATTR=NAME:cmds[] CONTENT=YES\n" +
               "WAIT SECONDS=1\n" +
               this.repeatExecute(2, 1) +
               "WAIT SECONDS=40\n";
    },
    
    createSetNormal1: function(url) {
        return "CODE:\n" +
               "URL GOTO=" + url + "\n" +
               "WAIT SECONDS=1200\n" +
               "TAG POS=1 TYPE=A ATTR=TXT:Run<SP>Cmds\n" +
               "FRAME F=1\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=SPAN ATTR=TXT:set<SP>queue<SP>--mode=normal<SP>[domain]/[vmta]\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=8 TYPE=INPUT:CHECKBOX ATTR=NAME:cmds[] CONTENT=YES\n" +
               "WAIT SECONDS=1\n" +
               this.repeatExecute(2, 3);
    },
    
    createDeleteQueue: function(url) {
        return "CODE:\n" +
               "SET !ERRORIGNORE YES\n" +
               "URL GOTO=" + url + "\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=A ATTR=TXT:Run<SP>Cmds\n" +
               "FRAME F=1\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=SPAN ATTR=TXT:delete<SP>--queue=[domain]/[vmta]\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=3 TYPE=INPUT:CHECKBOX ATTR=NAME:cmds[] CONTENT=YES\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=SPAN ATTR=TXT:reset<SP>counters\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=6 TYPE=INPUT:CHECKBOX ATTR=NAME:cmds[] CONTENT=YES\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=BUTTON ATTR=ID:execute\n" +
               "WAIT SECONDS=15\n";
    },
    
    createSchedule: function(url, namep) {
        return "CODE:\n" +
               "SET !ERRORIGNORE YES\n" +
               "URL GOTO=" + url + "\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=A ATTR=TXT:Run<SP>Cmds\n" +
               "FRAME F=1\n" +
               "WAIT SECONDS=2\n" +
               "URL GOTO=javascript:document.title='" + namep + "';undefined;\n" +
               "WAIT SECONDS=2\n" +
               "TAG POS=5 TYPE=INPUT:CHECKBOX ATTR=NAME:cmds[] CONTENT=YES\n" +
               "WAIT SECONDS=1\n" +
               this.repeatExecute(config.macro.scheduleRepeats, config.macro.scheduleWait);
    },
    
    createDeleteQueue1: function(url) {
        return "CODE:\n" +
               "SET !ERRORIGNORE YES\n" +
               "URL GOTO=" + url + "\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=A ATTR=TXT:Run<SP>Cmds\n" +
               "FRAME F=1\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=SPAN ATTR=TXT:delete<SP>--queue=[domain]/[vmta]\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=3 TYPE=INPUT:CHECKBOX ATTR=NAME:cmds[] CONTENT=YES\n" +
               "WAIT SECONDS=1\n" +
               "WAIT SECONDS=1\n" +
               "TAG POS=1 TYPE=BUTTON ATTR=ID:execute\n" +
               "WAIT SECONDS=5\n" +
               "TAG POS=1 TYPE=BUTTON ATTR=ID:execute\n" +
               "WAIT SECONDS=5\n" +
               "TAG POS=1 TYPE=BUTTON ATTR=ID:execute\n" +
               "WAIT SECONDS=5\n" +
               "URL GOTO=" + url + "\n" +
               "SET !ERRORIGNORE NO\n";
    },
    
    repeatExecute: function(times, wait) {
        var result = "";
        for (var i = 0; i < times; i++) {
            result += "TAG POS=1 TYPE=BUTTON ATTR=ID:execute\n" +
                      "WAIT SECONDS=" + wait + "\n";
        }
        return result;
    }
};

var notificationHandler = {
    send: function(targetTime, status) {
        try {
            var message = status === 1 ? 
                "\u25B6\uFE0F Process Started\n\n\uD83C\uDFAF Target: " + targetTime + "\n\u26A1\uFE0F Status: Executing" :
                "\u2705 Status: Completed \u2705";
            
            // Encode the message
            var encoded = encodeURIComponent(message);
            var macro = "CODE:\nSET !ERRORIGNORE YES\n" +
                       "URL GOTO=https://api.telegram.org/bot" + config.telegram.botToken +
                       "/sendMessage?chat_id=" + config.telegram.chatId +
                       "&text=" + encoded + "\n" +
                       "WAIT SECONDS=2\nSET !ERRORIGNORE NO\n";
            
            iimPlay(macro);
            utils.log("Notification sent");
            return true;
        } catch (e) {
            utils.log("Notification error: " + e);
            return false;
        }
    }
};

var executor = {
    run: function(item, lastpmta, iteration) {
        try {
            var targetTime = config.enableFinishTime ? 
                timeManager.addHours(item.targetTime, iteration) : item.targetTime;
            
            utils.log("Target: " + targetTime);
            
            var remaining = timeManager.calculateRemaining(targetTime);
            var waitTime = Math.max(0, remaining - 3680);
            
            var hours = Math.floor(waitTime / 3600);
            var mins = Math.floor((waitTime % 3600) / 60);
            utils.log("Waiting " + hours + "h " + mins + "m");
            
            var namep = "Prod__:__" + item.nameprod + "__" + targetTime;
            
            utils.log("WAITING");
            iimPlay(macroBuilder.createWaiting(waitTime, lastpmta, namep));
			utils.log("SEND NOTIFICATION");
			notificationHandler.send(targetTime, 1);
            utils.log("Mod set Normal");
            iimPlay(macroBuilder.createSetNormal(item.url));
            utils.log("DELETE RESET QUEUES 1");
			iimPlay(macroBuilder.createDeleteQueue(item.url));
            utils.log("SCHEDULE");
            iimPlay(macroBuilder.createSchedule(item.url, namep));
            utils.log("Mod set Normal");
            utils.log("EXTRACTING DATA");
			dataExtractor.extractAllData();
            iimPlay(macroBuilder.createSetNormal(item.url));
            utils.log("DELETE RESET QUEUES 2");
            dataExtractor.extractAllData();
            iimPlay(macroBuilder.createDeleteQueue1(item.url));
            notificationHandler.send(targetTime, 2);
            iimPlay(macroBuilder.createSetNormal1(item.url));
            
            var finalize = "CODE:\nSET !ERRORIGNORE YES\nWAIT SECONDS=3\nURL GOTO=" + item.url + "\n";
            iimPlay(finalize);
            
        } catch (e) {
            utils.log("Execution error: " + e);
        }
    }
};

function main() {
    try {
        utils.log("Script started");
        var iteration = 0;
        var running = true;
        
        while (running) {
            iteration++;
            utils.log("Iteration " + iteration);
            
            if (config.enableFinishTime) {
                if (timeManager.shouldStop()) {
                    iimPlay("CODE:PROMPT \"Finish time approaching. Stopped.\"\n");
                    break;
                }
            } else {
                running = false;
            }
            
            for (var i = 0; i < pmtaList.length; i++) {
                var lastUrl = i === 0 ? pmtaList[i].url : pmtaList[i-1].url;
                executor.run(pmtaList[i], lastUrl, iteration - 1);
                
                if (config.enableFinishTime && timeManager.shouldStop()) {
                    running = false;
                    break;
                }
            }
        }
        
        utils.log("Completed");
    } catch (e) {
        utils.log("Main error: " + e);
    }
}

main();`;

        // Function to apply syntax highlighting
        function applySyntaxHighlighting(code) {
            return code
                .replace(/(var|function|if|else|for|while|try|catch|return|new|Date|Math|JSON|parseInt|isNaN|toLocaleString|Object|Array|String|Number|Boolean|RegExp)(?=\s|\(|\)|;)/g, '<span class="keyword">$1</span>')
                .replace(/(\/\/.*)/g, '<span class="comment">$1</span>')
                .replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="comment">$1</span>')
                .replace(/("[^"]*"|'[^']*')/g, '<span class="string">$1</span>')
                .replace(/\b(\d+)\b/g, '<span class="number">$1</span>')
                .replace(/(\w+)\s*:/g, '<span class="variable">$1</span>:')
                .replace(/(\w+)\.(prototype\.)?(\w+)\s*\(/g, '$1.$2<span class="function">$3</span>(');
        }

        // Display the script content with syntax highlighting
        document.getElementById('codeContent').innerHTML = '<pre>' + applySyntaxHighlighting(scriptContent) + '</pre>';

        // Copy code functionality
        document.getElementById('copyCode').addEventListener('click', function() {
            navigator.clipboard.writeText(scriptContent).then(function() {
                showNotification('Code copied to clipboard!');
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                showNotification('Failed to copy code. Please try again.');
            });
        });

        // Download script functionality
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const blob = new Blob([scriptContent], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script_v2.0.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Script downloaded successfully!');
        });

        // View raw code in new tab
        document.getElementById('previewRawBtn').addEventListener('click', function() {
            const blob = new Blob([scriptContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            showNotification('Opening raw code in new tab...');
        });

        // Preview size controls
        const heightInput = document.getElementById('previewHeight');
        const fontSizeInput = document.getElementById('fontSize');
        const codeContainer = document.getElementById('codeContainer');
        const codeContent = document.getElementById('codeContent');

        heightInput.addEventListener('input', function() {
            const height = parseInt(this.value);
            if (height >= 300 && height <= 1000) {
                codeContainer.style.height = height + 'px';
            }
        });

        fontSizeInput.addEventListener('input', function() {
            const fontSize = parseInt(this.value);
            if (fontSize >= 10 && fontSize <= 20) {
                codeContent.style.fontSize = fontSize + 'px';
            }
        });

        // Show notification function
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = message;
            notification.style.display = 'flex';
            
            setTimeout(function() {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>