<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seeds & IPs Manager ‚Äî Full</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { 
      box-sizing: border-box; 
      margin:0; 
      padding:0; 
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height:1.6;
      color:#333;
      background: linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
      padding:20px;
      min-height:100vh;
    }

    .app-container {  
      margin:0 auto; 
      background:white; 
      border-radius:12px; 
      box-shadow:0 2px 10px rgba(0, 0, 0, 0.08); 
      overflow:hidden; 
    }
    
    .main-content { 
      padding:25px 30px; 
    }

    /* Seeds section */
    .seed-management-section {
      margin-bottom:25px; 
      padding:20px; 
      background:#f8f9fa; 
      border-radius:8px; 
      border-left:4px solid #28a745;
      border-right:4px solid #28a745;
    }
    
    .seed-management-header { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:15px; 
    }
    
    .seed-management-title { 
      font-weight:600; 
      font-size:1.2rem; 
    }
    
    .seed-form { 
      display:flex; 
      gap:10px; 
      margin-bottom:15px; 
      flex-wrap:wrap; 
    }
    
    .seed-name-input, 
    .seed-quantity-input, 
    .seed-selector {
      width:100%; 
      padding:12px; 
      border:1px solid #e1e5e9; 
      border-radius:6px; 
      background:white; 
    }
    
    .seed-name-input { 
      flex:1; 
      min-width:200px; 
    }
    
    .seed-quantity-input { 
      width:140px; 
    }
    
    .add-seed-btn { 
      background:#28a745; 
      color:white; 
      border:none; 
      padding:12px 20px; 
      border-radius:6px; 
      font-weight:600; 
      cursor:pointer; 
    }
    
    .add-seed-btn:hover{ 
      background:#218838; 
    }

    .seed-selector-container { 
      display:flex; 
      gap:10px; 
      align-items:center; 
      margin-bottom:10px; 
    }
    
    .remove-btn { 
      background:#dc3545; 
      color:white; 
      border:none; 
      width:66px; 
      height:36px; 
      border-radius:6px; 
      cursor:pointer; 
      font-weight:700; 
      font-size:16px; 
    }

    .seeds-usage-display { 
      display:flex; 
      gap:15px; 
      flex-wrap:wrap; 
      margin-top:15px; 
    }
    
    .seed-usage-item { 
      background:white; 
      padding:12px 15px; 
      border-radius:6px; 
      border:1px solid #e1e5e9; 
      min-width:200px; 
      transition: all 0.2s ease; 
    }
    
    .seed-usage-item.selected { 
      background: #e8f4fd; 
      border-color: #4a6ee0; 
    }
    
    .seed-usage-name { 
      font-weight:600; 
      margin-bottom:6px; 
      color:#333; 
    }
    
    .seed-usage-value-container { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin-bottom: 6px; 
    }
    
    .seed-usage-value { 
      font-size:1.1rem; 
      font-weight:600; 
      color:#4a6ee0; 
      cursor:pointer; 
      padding:5px; 
      border-radius:4px; 
      display:inline-block; 
      flex: 1; 
    }
    
    .seed-usage-value:hover { 
      background:rgba(0,0,0,0.04); 
    }
    
    .seed-usage-value-input { 
      font-size:1.1rem; 
      font-weight:600; 
      color:#4a6ee0; 
      padding:6px; 
      border:1px solid #4a6ee0; 
      border-radius:4px; 
      width:100%; 
      background:white; 
    }
    
    .copy-seed-used-btn { 
      background: #4a6ee0; 
      color: white; 
      border: none; 
      padding: 6px 10px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }
    
    .copy-seed-used-btn:hover { 
      background: #3a5ac8; 
    }

    .seed-usage-remaining { 
      font-size:0.9rem; 
      color:#6c757d; 
      margin-top:6px; 
    }
    
    .seed-last-update { 
      font-size:0.8rem; 
      color:#6c757d; 
      margin-top:4px; 
      font-style:italic; 
    }

    /* IP Blocks */
    .controls { 
      display:flex; 
      gap:10px; 
      margin-bottom:20px; 
      flex-wrap:wrap; 
    }
    
    .add-block-btn, 
    .copy-btn, 
    .clear-btn { 
      background:#4a6ee0;
      width:250px; 
      color:white; 
      border:none; 
      padding:10px 16px; 
      border-radius:6px; 
      cursor:pointer; 
      font-weight:600; 
    }
    
    .copy-btn { 
      background:#ffc107; 
      color:#212529; 
    }
    
    .clear-btn { 
      background:#dc3545; 
    }

    .ip-blocks-container { 
      display:flex; 
      flex-wrap:wrap; 
      gap:20px; 
      margin-bottom:20px; 
    }
    
    .ip-block {
      border-left: #19a919 4px solid;
      border-right: #19a919 4px solid;
      background:#f8f9fa; 
      border-radius:8px; 
      padding:20px; 
      box-shadow:0 1px 3px rgba(0,0,0,0.05);  
      flex:0 0 calc(33.333% - 14px); 
      min-width:300px; 
    }
    
    .ip-block-header { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:12px; 
    }
    
    .ip-block-title { 
      font-weight:600; 
      cursor:pointer; 
      padding:5px 8px; 
      border-radius:4px; 
    }
    
    .ip-block-title-input { 
      padding:6px 8px; 
      border:1px solid #4a6ee0; 
      border-radius:4px; 
      width:100%; 
    }
    
    .ip-textarea { 
      width:100%; 
      padding:12px; 
      border:1px solid #e1e5e9; 
      border-radius:6px; 
      font-family:monospace; 
      min-height:180px; 
      margin-bottom:12px; 
      resize:vertical; 
    }
    
    .volume-input-container { 
      display:flex; 
      gap:10px; 
      margin-bottom:12px; 
    }
    
    .volume-input { 
      flex:1; 
      padding:12px; 
      border:1px solid #e1e5e9; 
      border-radius:6px; 
    }
    
    .add-volume-btn { 
      background:#28a745; 
      color:white; 
      border:none; 
      padding:12px 16px; 
      border-radius:6px; 
      cursor:pointer; 
      font-weight:600; 
    }

    .stats { 
      padding:12px; 
      background:white; 
      border-radius:6px; 
      font-size:0.9rem; 
      color:#6c757d; 
      border:1px solid #e1e5e9; 
    }

    .empty-state { 
      text-align:center; 
      padding:40px 20px; 
      color:#6c757d; 
      width:100%; 
    }

    .copy-notification, 
    .save-notification { 
      position:fixed; 
      top:20px; 
      right:20px; 
      background:#28a745; 
      color:white; 
      padding:12px 20px; 
      border-radius:6px; 
      box-shadow:0 2px 10px rgba(0, 0, 0, 0.08); 
      z-index:1000; 
      opacity:0; 
      transition:opacity .3s; 
    }
    
    .copy-notification.show, 
    .save-notification.show { 
      opacity:1; 
    }

    @media (max-width:1200px) { 
      .ip-block { 
        flex:0 0 calc(50% - 10px); 
      } 
    }
    
    @media (max-width:768px) {
      .ip-block { 
        flex:0 0 100%; 
      }
      
      .seed-form { 
        flex-direction:column; 
      }
      
      .seed-selector-container { 
        flex-direction:row; 
      }
      
      .controls { 
        flex-direction:column; 
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-content">

      <!-- Seeds -->
      <div class="seed-management-section">
        <div class="seed-management-header">
          <div class="seed-management-title">Seed Management</div>
        </div>

        <div class="seed-form">
          <input type="text" id="seedName" class="seed-name-input" placeholder="Enter seed name" />
          <input type="number" id="seedQuantity" class="seed-quantity-input" placeholder="Initial Quantity" min="0" />
          <button class="add-seed-btn" onclick="addSeed()">Add Seed</button>
        </div>

        <div class="seed-selector-container">
          <label style="font-weight:500;width:200px; color:#6c757d;margin-right:8px;">Select Seed:</label>
          <select id="seedSelector" class="seed-selector" onchange="showSeedDetails()">
            <option value="">-- Select a seed --</option>
          </select>

          <button class="remove-btn" onclick="removeSelectedSeed()" title="Remove selected seed">√ó</button>

          <button class="add-block-btn" style="margin-left:auto" onclick="addIPBlock()">+ Add Block</button>
          <button class="clear-btn" onclick="clearAllData()">üóëÔ∏è Clear All</button>
        </div>

        <div id="seedsUsageDisplay" class="seeds-usage-display"></div>
      </div>

      <!-- IP Blocks -->
      <div id="ipsContainer" class="ip-blocks-container">
        <div class="empty-state" id="emptyState">
          <p>No blocks added yet.</p>
          <p>Click "Add  Block" to get started.</p>
        </div>
      </div>

    </div>
  </div>

  <div id="saveNotification" class="save-notification">Data saved automatically!</div>
  <div id="copyNotification" class="copy-notification">Copied to clipboard!</div>

  <script>
    /***** State *****/
    let blockCounter = 1;
    let saveTimeout = null;
    let seeds = {}; // { name: { initialQuantity:number, used:number, lastUpdate: timestamp } }

    /***** Utilities *****/
    function getCurrentTimestamp() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function showSaveNotification() {
      const el = document.getElementById('saveNotification');
      el.classList.add('show');
      el.style.opacity = '1';
      setTimeout(()=>{ 
        el.style.opacity = '0'; 
        el.classList.remove('show'); 
      }, 1400);
    }

    function showCopyNotification() {
      const el = document.getElementById('copyNotification');
      el.classList.add('show');
      el.style.opacity = '1';
      setTimeout(()=>{ 
        el.style.opacity = '0'; 
        el.classList.remove('show'); 
      }, 1400);
    }

    function debounceSave() {
      if (saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveData, 500);
    }

    /***** Persistence *****/
    function saveData() {
      const data = {
        seeds: seeds,
        ipBlocks: [],
        selectedSeed: document.getElementById('seedSelector').value
      };

      document.querySelectorAll('.ip-block').forEach(block => {
        const id = block.id;
        const title = block.querySelector('.ip-block-title') ? block.querySelector('.ip-block-title').textContent : '';
        const ips = block.querySelector('.ip-textarea') ? block.querySelector('.ip-textarea').value : '';
        const volume = block.querySelector('.volume-input') ? block.querySelector('.volume-input').value : '';
        const stats = block.querySelector('.stats') ? block.querySelector('.stats').innerHTML : '';
        data.ipBlocks.push({ id, name: title, ips, volume, stats });
      });

      localStorage.setItem('seedsManagerData', JSON.stringify(data));
      showSaveNotification();
      updateSeedsUsageDisplay();
    }

    function loadData() {
      const saved = localStorage.getItem('seedsManagerData');
      if (!saved) return;

      try {
        const data = JSON.parse(saved);
        seeds = data.seeds || {};
        updateSeedSelector();

        if (data.ipBlocks && data.ipBlocks.length) {
          document.getElementById('emptyState').style.display = 'none';
          data.ipBlocks.forEach(b => createIPBlockFromData(b));
        }

        if (data.selectedSeed) {
          document.getElementById('seedSelector').value = data.selectedSeed;
        }
      } catch (e) {
        console.error('Failed to load saved data', e);
      }

      updateSeedsUsageDisplay();
    }

    /***** Seed functions *****/
    function addSeed() {
      const nameInput = document.getElementById('seedName');
      const qtyInput = document.getElementById('seedQuantity');
      const name = nameInput.value.trim();
      const quantity = parseInt(qtyInput.value) || 0;

      if (!name) { 
        alert('Please enter a seed name'); 
        return; 
      }
      
      if (quantity < 0) { 
        alert('Please enter a valid quantity'); 
        return; 
      }

      seeds[name] = { 
        initialQuantity: quantity, 
        used: 0, 
        lastUpdate: getCurrentTimestamp() 
      };
      
      updateSeedSelector();
      document.getElementById('seedSelector').value = name;
      nameInput.value = ''; 
      qtyInput.value = '';
      saveData();
    }

    function updateSeedSelector() {
      const selector = document.getElementById('seedSelector');
      const current = selector.value;
      
      // remove options except first
      while (selector.options.length > 1) selector.remove(1);

      for (const name in seeds) {
        const opt = document.createElement('option');
        opt.value = name;
        const totalseeds = seeds[name].initialQuantity ;
        opt.textContent = `${name} | Total seeds: ${totalseeds}`;
        selector.appendChild(opt);
      }

      if (current && seeds[current]) selector.value = current;
      highlightSelectedSeed();
    }

    function showSeedDetails() {
      highlightSelectedSeed();
    }

    function highlightSelectedSeed() {
      // Remove 'selected' class from all seed usage items
      document.querySelectorAll('.seed-usage-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add 'selected' class to the currently selected seed
      const selectedSeed = document.getElementById('seedSelector').value;
      if (selectedSeed) {
        document.querySelectorAll('.seed-usage-item').forEach(item => {
          const seedNameElement = item.querySelector('.seed-usage-name');
          if (seedNameElement && seedNameElement.textContent === selectedSeed) {
            item.classList.add('selected');
          }
        });
      }
    }

    function removeSelectedSeed() {
      const selector = document.getElementById('seedSelector');
      const selected = selector.value;
      
      if (!selected) { 
        alert('Please select a seed to remove'); 
        return; 
      }
      
      if (!confirm(`Remove seed "${selected}"?`)) return;
      
      delete seeds[selected];
      updateSeedSelector();
      selector.value = '';
      saveData();
    }

    /***** Seeds usage display & editing used (the requested feature) *****/
    function updateSeedsUsageDisplay() {
      const container = document.getElementById('seedsUsageDisplay');
      container.innerHTML = '';
      
      for (const name in seeds) {
        const data = seeds[name];
        const remaining = data.initialQuantity - data.used;
        const last = data.lastUpdate || 'Never';

        const item = document.createElement('div');
        item.className = 'seed-usage-item';
        
        // Check if this seed is currently selected
        const selectedSeed = document.getElementById('seedSelector').value;
        if (name === selectedSeed) {
          item.classList.add('selected');
        }

        const nameEl = document.createElement('div');
        nameEl.className = 'seed-usage-name';
        nameEl.textContent = name;
        item.appendChild(nameEl);

        // Create container for value and copy button
        const valueContainer = document.createElement('div');
        valueContainer.className = 'seed-usage-value-container';

        const valueEl = document.createElement('div');
        valueEl.className = 'seed-usage-value';
        valueEl.textContent = data.used;
        valueEl.onclick = function() { 
          makeSeedUsageEditable(name, valueEl); 
        };
        valueContainer.appendChild(valueEl);

        // Add copy button
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-seed-used-btn';
        copyBtn.innerHTML = 'üìã';
        copyBtn.title = 'Copy seeds used value';
        copyBtn.onclick = function(e) {
          e.stopPropagation(); // Prevent triggering the value edit
          copySeedUsedValue(name, data.used);
        };
        valueContainer.appendChild(copyBtn);

        item.appendChild(valueContainer);

        const remEl = document.createElement('div');
        remEl.className = 'seed-usage-remaining';
        remEl.textContent = `Remaining: ${remaining}`;
        item.appendChild(remEl);

        const lastEl = document.createElement('div');
        lastEl.className = 'seed-last-update';
        lastEl.textContent = `Last update: ${last}`;
        item.appendChild(lastEl);

        container.appendChild(item);
      }
    }

    // Copy seeds used value to clipboard
    function copySeedUsedValue(seedName, value) {
      navigator.clipboard.writeText(value.toString())
        .then(() => {
          showCopyNotification();
        })
        .catch(err => {
          console.error('Failed to copy: ', err);
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = value.toString();
          document.body.appendChild(textArea);
          textArea.select();
          
          try {
            document.execCommand('copy');
            showCopyNotification();
          } catch (err) {
            console.error('Fallback copy failed: ', err);
            alert('Failed to copy value to clipboard');
          }
          
          document.body.removeChild(textArea);
        });
    }

    // Editable used value (click -> input -> save)
    function makeSeedUsageEditable(seedName, valueElement) {
      const currentValue = valueElement.textContent;
      const input = document.createElement('input');
      input.type = 'number';
      input.value = currentValue;
      input.className = 'seed-usage-value-input';
      input.min = '0';

      valueElement.parentNode.replaceChild(input, valueElement);
      input.focus();
      input.select();

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') saveSeedUsage(seedName, input);
        else if (e.key === 'Escape') cancelSeedUsageEdit(input, currentValue, seedName);
      });

      input.addEventListener('blur', function() {
        saveSeedUsage(seedName, input);
      });
    }

    function saveSeedUsage(seedName, inputElement) {
      let newUsage = parseInt(inputElement.value);
      if (isNaN(newUsage) || newUsage < 0) newUsage = 0;

      const initial = seeds[seedName].initialQuantity;
      if (newUsage > initial) {
        alert(`Usage cannot exceed the initial quantity (${initial})`);
        inputElement.value = seeds[seedName].used;
        inputElement.focus();
        return;
      }

      seeds[seedName].used = newUsage;
      seeds[seedName].lastUpdate = getCurrentTimestamp();

      const valueEl = document.createElement('div');
      valueEl.className = 'seed-usage-value';
      valueEl.textContent = newUsage;
      valueEl.onclick = function() { 
        makeSeedUsageEditable(seedName, valueEl); 
      };

      inputElement.parentNode.replaceChild(valueEl, inputElement);
      updateSeedSelector();
      saveData();
    }

    function cancelSeedUsageEdit(inputElement, originalValue, seedName) {
      const valueEl = document.createElement('div');
      valueEl.className = 'seed-usage-value';
      valueEl.textContent = originalValue;
      valueEl.onclick = function() { 
        makeSeedUsageEditable(seedName, valueEl); 
      };
      inputElement.parentNode.replaceChild(valueEl, inputElement);
    }

    /***** IP Blocks functions *****/
    function addIPBlock() {
      const empty = document.getElementById('emptyState');
      if (empty) empty.style.display = 'none';

      const blockData = { 
        id: `ip-block-${blockCounter}`, 
        name: `IP Block ${blockCounter}`, 
        ips:'', 
        volume:'', 
        stats:'No data added yet.' 
      };
      
      createIPBlockFromData(blockData);
      saveData();
    }

    function createIPBlockFromData(blockData) {
      const container = document.createElement('div');
      container.className = 'ip-block';
      container.id = blockData.id;

      // header
      const header = document.createElement('div'); 
      header.className = 'ip-block-header';
      
      const title = document.createElement('div'); 
      title.className = 'ip-block-title'; 
      title.textContent = blockData.name;
      title.onclick = () => makeTitleEditable(title);
      
      const removeBtn = document.createElement('button'); 
      removeBtn.className = 'remove-btn'; 
      removeBtn.innerHTML = '&times;';
      removeBtn.onclick = () => {
        if (!confirm('Remove this IP block?')) return;
        container.remove();
        saveData();
        
        if (document.querySelectorAll('.ip-block').length === 0) {
          document.getElementById('emptyState').style.display = 'block';
        }
      };
      
      header.appendChild(title); 
      header.appendChild(removeBtn);

      // IP textarea
      const ipLabel = document.createElement('label'); 
      ipLabel.className='section-label'; 
      ipLabel.textContent='IP Addresses (one per line)';
      
      const ipTextarea = document.createElement('textarea'); 
      ipTextarea.className='ip-textarea'; 
      ipTextarea.placeholder='192.168.1.1\n10.0.0.5'; 
      ipTextarea.value = blockData.ips || '';
      ipTextarea.addEventListener('input', debounceSave);

      // volume
      const volumeLabel = document.createElement('label'); 
      volumeLabel.className='section-label'; 
      volumeLabel.textContent='Volume per IP';
      
      const volumeContainer = document.createElement('div'); 
      volumeContainer.className='volume-input-container';
      
      const volumeInput = document.createElement('input'); 
      volumeInput.type='number'; 
      volumeInput.className='volume-input'; 
      volumeInput.placeholder='Enter volume'; 
      volumeInput.min='0'; 
      volumeInput.step='0.01'; 
      volumeInput.value = blockData.volume || '';
      volumeInput.addEventListener('input', debounceSave);
      
      const addBtn = document.createElement('button'); 
      addBtn.className='add-volume-btn'; 
      addBtn.innerText='Add Volume to Selected Seed';
      addBtn.onclick = function() {
        const selectedSeed = document.getElementById('seedSelector').value;
        if (!selectedSeed) { 
          alert('Please select a seed first'); 
          return; 
        }

        const ips = ipTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
        const ipCount = ips.length;
        const volume = parseFloat(volumeInput.value) || 0;
        const totalVolume = volume * ipCount;

        const seed = seeds[selectedSeed];
        const remainingBefore = seed.initialQuantity - seed.used;
        
        // Check if initial quantity < (used + totalVolume)
        if (seed.initialQuantity < seed.used + totalVolume) {
          // Drop 1: (Initial Quantity - seeds used)
          const drop1 = seed.initialQuantity - seed.used;
          
          // Drop 2: seeds used = (value stat total - value drop 1)
          const drop2 = totalVolume - drop1;
          
          // Update stats div with calculation details
          updateStats(container, ipCount, volume, totalVolume, drop1, drop2);
          
          seed.used = drop2;
        } else {
          // Normal case: just add the total volume
          seed.used += totalVolume;
          updateStats(container, ipCount, volume, totalVolume);
        }

        seed.lastUpdate = getCurrentTimestamp();
        updateSeedSelector();
        saveData();
      };

      volumeContainer.appendChild(volumeInput);
      volumeContainer.appendChild(addBtn);

      // stats
      const stats = document.createElement('div'); 
      stats.className = 'stats'; 
      stats.innerHTML = blockData.stats || 'No data added yet.';

      // assemble
      container.appendChild(header);
      container.appendChild(ipLabel);
      container.appendChild(ipTextarea);
      container.appendChild(volumeLabel);
      container.appendChild(volumeContainer);
      container.appendChild(stats);

      document.getElementById('ipsContainer').appendChild(container);
      blockCounter++;
    }

    function updateStats(container, ipCount, volume, totalVolume, drop1, drop2) {
      const stats = container.querySelector('.stats');
      if (ipCount === 0) {
        stats.innerHTML = 'No valid IP addresses entered.';
      } else {
        if (drop1 !== undefined && drop2 !== undefined) {
          // Show calculation details
          stats.innerHTML = `
            <div><strong <strong style="font-size:15px; padding:4px; border-radius:8px; font-family: Helvetica, Arial, sans-serif; color:black;">Calculation Details:</strong></div>
            <div >Drop 1 : <strong style="font-size:15px; padding:4px; border-radius:8px; font-family: Helvetica, Arial, sans-serif; color:black;">${drop1}</strong></div>
            <div >Drop 2 :<strong style="font-size:15px; padding:4px; border-radius:8px; font-family: Helvetica, Arial, sans-serif; color:black;">${drop2}</strong></div>
          `;
        } else {
          // Normal stats
          stats.innerHTML = `<strong>Stats:</strong> ${ipCount} IP(s) √ó ${volume} volume = <strong>${totalVolume}</strong> added to selected seed`;
        }
      }
    }

    // Title editing
    function makeTitleEditable(titleElement) {
      const currentText = titleElement.textContent;
      const input = document.createElement('input'); 
      input.type='text'; 
      input.value=currentText; 
      input.className='ip-block-title-input';
      
      titleElement.parentNode.replaceChild(input, titleElement);
      input.focus(); 
      input.select();

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') saveTitle(input);
        else if (e.key === 'Escape') cancelTitleEdit(input, currentText);
      });
      
      input.addEventListener('blur', () => saveTitle(input));
    }

    function saveTitle(inputElement) {
      const newTitle = inputElement.value.trim();
      const titleElement = document.createElement('div'); 
      titleElement.className='ip-block-title'; 
      titleElement.textContent = newTitle || `IP Block ${blockCounter}`;
      titleElement.onclick = function(){ 
        makeTitleEditable(titleElement); 
      };
      
      inputElement.parentNode.replaceChild(titleElement, inputElement);
      saveData();
    }

    function cancelTitleEdit(inputElement, originalText) {
      const titleElement = document.createElement('div'); 
      titleElement.className='ip-block-title'; 
      titleElement.textContent = originalText;
      titleElement.onclick = function(){ 
        makeTitleEditable(titleElement); 
      };
      
      inputElement.parentNode.replaceChild(titleElement, inputElement);
    }

    /***** Clear all data *****/
    function clearAllData() {
      if (!confirm('Are you sure you want to clear all data? This cannot be undone.')) return;
      
      localStorage.removeItem('seedsManagerData');
      document.querySelectorAll('.ip-block').forEach(b => b.remove());
      document.getElementById('emptyState').style.display = 'block';
      blockCounter = 1;
      seeds = {};
      updateSeedSelector();
      updateSeedsUsageDisplay();
    }

    /***** Initialization *****/
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
    });

    // Add demo blocks + seeds if no saved data
    window.onload = function() {
      if (!localStorage.getItem('seedsManagerData')) {
        addIPBlock();
        addIPBlock();

        const currentTime = getCurrentTimestamp();
        seeds = {
          "Wheat": { initialQuantity: 100, used: 0, lastUpdate: currentTime },
          "Corn":  { initialQuantity: 150, used: 0, lastUpdate: currentTime },
          "Rice":  { initialQuantity: 200, used: 0, lastUpdate: currentTime }
        };
        
        updateSeedSelector();
        document.getElementById('seedSelector').value = "Wheat";
        updateSeedsUsageDisplay();
      } else {
        // ensure display updated in case loadData created blocks and seeds
        updateSeedsUsageDisplay();
      }
    };
  </script>
</body>
</html>